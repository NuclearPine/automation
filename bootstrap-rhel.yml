---
# This playbook is only designed to be run against newly installed hosts only.
# When running this playbook, use the following syntax:
# ansible-playbook -i <ip address>, -l <ip address> -u <valid_ssh_user> bootstrap-rhel.yml

- name: Bootstrap fresh RHEL/Alma/Rocky installation

  hosts: all
  order: sorted
  become: true
  gather_facts: false
  roles:
    - common

  vars_prompt:
    - name: ts_key
      prompt: Enter tailscale setup key
      private: false

  pre_tasks:
    - name: Fail when run against the main inventory
      when: inventory_hostname == '_failwhenfound'
      any_errors_fatal: yes
      fail:
        msg: >
          Error! You must specify a specific IP/hostname or custom inventory when running this playbook with the -i flag.

    - name: install tailscale repository
      copy:
        src: dnf-repos/tailscale.repo
        dest: /etc/yum.repos.d/tailscale.repo
        owner: root
        mode: 0644

    - name: Update all packages
      dnf:
        name: "*"
        state: latest
        update_cache: true
        allowerasing: true

    - name: Install tailscale
      dnf:
        name: tailscale
        state: present

    - name: start tailscaled
      service:
        name: tailscaled
        state: started
        enabled: true

    - name: tailscale up
      command: /usr/bin/tailscale up --auth-key={{ ts_key }} --accept-routes
